# 手动部署

对于有经验的用户，可以选择手动部署环境，并根据自己的需求进行定制。不推荐使用这种方式，依赖比较复杂，效率非常低。

## 安装dhcp服务

网络启动依赖dhcp服务，并且需要配置pxe启动参数。

```bash
# yum install dhcp
# chkconfig dhcpd on
```

配置dhcp服务，请用户根据自己的实际情况修改网段

```bash
# cat /etc/dhcp/dhcpd.conf
allow booting;
allow bootp;
ddns-update-style none;
ping-check true;
ping-timeout 3;
default-lease-time 120;
max-lease-time 600;
authoritative;
next-server osinstall.idcos.com;
filename "gpxelinux.0";
option domain-name-servers 192.168.0.1;
option domain-search "idcos.com";
option root-path "osinstall.idcos.com:/";

subnet 192.168.0.0 netmask 255.255.255.0 {
    range 192.168.0.101 192.168.0.200;
    option routers 192.168.0.1;
}
```

说明：

* `next-server` 指向tftp服务器，默认是本机ip
* `domain-name-servers` 指向dns服务器，默认是本机ip
* `domain-search` dns搜索域，请根据实际情况修改
* `root-path` 指向客户端的根路径，默认是本机ip
* `subnet` 分配的dhcp网段，请根据实际情况修改

## 安装tftp服务

安装tftp服务和syslinux的tftpboot工具，如下：

```bash
# yum install tftp-server syslinux-tftpboot
# chkconfig xinetd on
```

配置tftp服务，设定tftp根目录为```/var/lib/tftpboot```，修改```disable = no```

```bash
# cat /etc/xinetd.d/tftp
# default: off
# description: The tftp server serves files using the trivial file transfer \
#       protocol.  The tftp protocol is often used to boot diskless \
#       workstations, download configuration files to network-aware printers, \
#       and to start the installation process for some operating systems.
service tftp
{
        socket_type             = dgram
        protocol                = udp
        wait                    = yes
        user                    = root
        server                  = /usr/sbin/in.tftpd
        server_args             = -s /var/lib/tftpboot
        disable                 = no
        per_source              = 11
        cps                     = 100 2
        flags                   = IPv4
}
```

## 安装http服务

系统安装所需要的镜像源使用http的方式来提供，需要安装nginx并下载安装介质然后导入ISO文件生成安装源。

```bash
# rpm -ivh http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm
# yum install nginx
# chkconfig nginx on
```

下载系统安装介质，以centos 6.7为例，需要下载ISO文件并导入http目录。

```bash
# mkdir -p /home/www/iso /home/www/centos/6.7/os/x86_64/
# wget -c -P /home/www/iso http://mirrors.aliyun.com/centos/6.7/isos/x86_64/CentOS-6.7-x86_64-bin-DVD1.iso
# mount -o loop /home/www/iso/CentOS-6.7-x86_64-bin-DVD1.iso /media
# rsync -az /media/ /home/www/centos/6.7/os/x86_64/
# umount /media
```

## 安装dns服务

这里我们需要提供一套dns用作域名解析，如果内部环境已经有dns服务可以跳过此步骤。可以使用轻量级的dnsmasq来解决此问题，安装配置如下：

```bash
# yum install dnsmasq
# chkconfig dnsmasq on
```

安装好以后需要增加hosts.conf配置文件，这里假设新增的域名是```osinstall.idcos.com```，ip地址是```10.0.1.1```

```bash
# cat /etc/dnsmasq.conf
conf-dir=/etc/dnsmasq.d

# cat /etc/dnsmasq.d/hosts.conf
address=/osinstall/10.0.1.1
address=/osinstall.idcos.com/10.0.1.1
```

修改完成以后，启动dnsmasq服务，测试域名是否生效

```bash
# service dnsmasq start
# dig @127.0.0.1 osinstall.idcos.com A

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.30.rc1.el6_6.3 <<>> osinstall.idcos.com @127.0.0.1
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 13030
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;osinstall.idcos.com.           IN      A

;; ANSWER SECTION:
osinstall.idcos.com.    0       IN      A       10.0.1.1

;; Query time: 0 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Tue Mar  1 14:44:16 2016
;; MSG SIZE  rcvd: 53
```

## Server端部署

### 下载

推荐使用编译好的二进制程序(包含UI、Server、BootOS、初始数据等)

程序目录结构如下：

```bash
cloudboot-server
├── bootos
│   ├── initrd.img
│   └── vmlinuz
├── server
│   ├── cloudboot-server.sql
│   └── cloudboot-server-$version.x86_64.rpm
└── ui
    └── cloudboot-server-ui.tar.gz
```

其中：

* bootos目录包含了bootos启动所需内核vmlinuz以及文件系统initrd.img
* server目录包含了数据库表结构cloudboot-server.sql以及server安装包
* ui目录包含了ui的静态页面

### 初始化数据

* 我们使用的是开源的mysql数据库，需要先配置mysql并倒入表结构：

```bash
# yum install mysql-server
# service mysqld start
# chkconfig mysqld on
# mysql -uroot < /path/of/cloudboot-server.sql
```

### 部署server

* 安装`cloudboot-server`

```bash
# rpm -ivh /path/of/cloudboot-server-$version.x86_64.rpm
```

* 修改配置文件`/etc/cloudboot-server/cloudboot-server.conf`，其中`$user`和`$password`是连接数据库的用户名和密码，请根据实际情况修改

```bash
# cat /etc/cloudboot-server/cloudboot-server.conf
{
  "repo": {
    "connection":"$user:$password@tcp(127.0.0.1:3306)/idcos-osinstall?charset=utf8&parseTime=True&loc=Local"
  },
  "osInstall":{
    "pxeConfigDir":"/var/lib/tftpboot/pxelinux.cfg"
   },
  "logger":{
      "logFile":"/var/log/cloudboot-server.log",
      "level":"debug"
  }
}
```

* 启动cloudboot-server：

```bash
# service cloudboot-server start
```

### 部署UI前端

* 解压 cloudboot-server-ui.tar.gz 到web server目录

```bash
# mkdir /home/www
# tar zxpf /path/of/cloudboot-server-ui.tar.gz -C /home/www
```

* 设置http根目录和api转发规则，以nginx为例，修改配置文件`/etc/nginx/conf.d/default.conf`如下：

```nginx
server {
    listen       80 default_server;
    server_name  _;

    include /etc/nginx/default.d/*.conf;

    location / {
        root   /home/www;
        index  index.html index.htm;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:8083;
    }

    error_page  404              /404.html;
    location = /404.html {
        root   /usr/share/nginx/html;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}
```

其中：

* `root /home/www;` 参数指向http的根目录是`/home/www`
* `proxy_pass http://127.0.0.1:8083;` 将api请求转发到本机的`8083`端口，即`cloudboot-server`监听的端口

部署完成后，访问地址：

[http://localhost/](http://localhost/)
